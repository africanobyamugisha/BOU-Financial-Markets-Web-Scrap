---
title: "BOU Web Scrapping"
author: "africano.byanmugisha@asigmacapital.com"
date: "3/7/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries}
# LIBRARIES
pacman::p_load(
dplyr,
rvest,
data.table,
tm,
readxl,
httr
)
```


# Description
- This code first uses the rvest package to scrape the webpage for links to the daily excel files. 
- It then extracts the links and titles and stores them in a data frame. 
- The DT package is used to combine the excel files into one data table, which is then written to a new excel file using the writexl package.


# scrape the webpage for links
```{r}
url <- "https://www.bou.or.ug/bou/bouwebsite/FinancialMarkets/Closing-TBondsPrices-Yield.html"
webpage <- read_html(url)
```


# extract links and titles
```{r}
links <- webpage %>% 
html_nodes(".ap-linksequence a") %>%
  html_attr("href")

Date <- webpage %>%
  html_nodes(".ap-linksequence a") %>%
  html_text()

remove_words <- c("T-Bonds as at ","TBonds as at ", ".xlsx","T-Bonds-as-at-","Bonds-as-at-")
Date <- removeWords(Date, remove_words)

```


# create a data frame of links and titles
```{r}

df_links <- data.frame(Date,links)

for(i in 1:nrow(df_links)){
  df_links$links[i] <- paste0("https://www.bou.or.ug",df_links$links[i])
}
```


# read excel files into a list
```{r}

# specify the URL of the Excel file
url1 <- df_links$links[1]

GET(url1, write_disk(dt <- tempfile(fileext = ".xlsx")))
dtt <- read_excel(dt, sheet = grep("Bonds", excel_sheets(dt), value = TRUE),
                 range = cell_cols("A:C"),
                 col_names = TRUE, 
                 col_types = c("date", "numeric", "numeric"),
                 .name_repair = toupper
                 )

```

```{r}
merge_dt <- data.frame()

for(i in 1:nrow(df_links)){
  GET(df_links$links[i], write_disk(dt <- tempfile(fileext = ".xlsx")))
  temp_dt <- read_excel(dt, sheet = grep("Bonds", excel_sheets(dt), value = TRUE),
                 range = cell_cols("A:C"),
                 col_names = TRUE, 
                 col_types = c("date", "numeric", "numeric"),
                 .name_repair = toupper
                 )
  
  merge_dt <- bind_rows(merge_dt, temp_dt)
}
```


# write the combined table to a new excel file
```{r}
write.xlsx(merge_dt, "combined_data.xlsx", row.names = FALSE)
```


